systemd:
  units:
    - name: matchbox.service
      enable: true
      contents: |
        [Unit]
        Description=CoreOS matchbox Server
        Documentation=https://github.com/coreos/matchbox

        [Service]
        Restart=always
        RestartSec=3
        Environment="MATCHBOX_ADDRESS=0.0.0.0:8080"
        ExecStart=/usr/bin/rkt run \
          --inherit-env \
          --trust-keys-from-https \
          --volume data,kind=host,source=/home/core/matchbox/examples \
          --volume example,kind=host,source=/home/core/matchbox/examples/groups/bootkube \
          --volume config,kind=host,source=/home/core/matchbox/examples/etc/matchbox \
          --mount volume=data,target=/var/lib/matchbox \
          --mount volume=example,target=/var/lib/matchbox/groups \
          --mount volume=config,target=/etc/matchbox \
          --insecure-options=image \
          --port=port-8080:8080 \
          --port=port-8080:80 \
          /home/core/matchbox/examples/assets/rkt/matchbox.aci

        [Install]
        WantedBy=multi-user.target
    - name: dnsmasq.service
      enable: true
      # systemd-resolv gets dhcp dns server
      # we point dnsmasq at it
      # we point /etc/resolv at dnsmasq
      contents: |
        [Unit]
        Description=dnsmasq

        [Service]
        Restart=always
        RestartSec=3
        ExecStart=/usr/bin/rkt run \
          --net=host \
          --trust-keys-from-https \
          --volume config,kind=host,source=/home/core/dnsmasq/bootstrap.conf \
          --volume hosts,kind=host,source=/etc/hosts.dns \
          --volume resolv,kind=host,source=/run/systemd/resolve/resolv.conf \
          --mount volume=config,target=/etc/dnsmasq.conf \
          --mount volume=hosts,target=/etc/hosts \
          --mount volume=resolv,target=/etc/resolv.conf \
          --insecure-options=image \
          /home/core/matchbox/examples/assets/rkt/dnsmasq.aci \
          --caps-retain=CAP_NET_ADMIN,CAP_NET_BIND_SERVICE,CAP_SETGID,CAP_SETUID,CAP_NET_RAW \
          -- -d -q \
          --log-queries
        [Install]
        WantedBy=multi-user.target
    - name: dns-helper.service
      enable: true
      contents: |
        [Unit]
        Description=Serves hostnames, adds them to dns
        After=network-online.target dnsmasq.service
        Wants=network-online.target

        [Service]
        Restart=always
        RestartSec=3
        ExecStartPre=/usr/bin/touch /etc/hosts.dns
        ExecStart=/usr/bin/docker run --rm -v /etc/hosts.dns:/etc/hosts \
          -v  /home/core/matchbox/taras/ignition_dns/ignition_dns.js:/ignition_dns.js \
          --name ignition_dns \
          --network=host \
          --pid=host \
          node:8.4-alpine \
          node ignition_dns.js bootstrap example.com  /etc/hosts 8081
        [Install]
        WantedBy=multi-user.target

storage:
  files:
    - path: /etc/hosts.dns
      filesystem: root
      mode: 0644
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - "ssh-rsa goes here"