---
#  ~/matchbox/contrib/dnsmasq $ sudo cp  docker0.conf /etc/dnsmasq.conf
#   DATA_MOUNT="-v $PWD/examples:/var/lib/matchbox -v $DIR/../examples/groups/$EXAMPLE:/var/lib/matchbox/groups"

systemd:
  units:
    - name: matchbox.service
      enable: true
      contents: |
        [Unit]
        Description=CoreOS matchbox Server
        Documentation=https://github.com/coreos/matchbox

        [Service]
        Environment="MATCHBOX_ADDRESS=0.0.0.0:8080"
        ExecStart=/usr/bin/rkt run \
          --inherit-env \
          --trust-keys-from-https \
          --volume data,kind=host,source=/home/core/matchbox/examples \
          --volume example,kind=host,source=/home/core/matchbox/examples/groups/bootkube \
          --volume config,kind=host,source=/home/core/matchbox/examples/etc/matchbox \
          --mount volume=data,target=/var/lib/matchbox \
          --mount volume=example,target=/var/lib/matchbox/groups \
          --mount volume=config,target=/etc/matchbox \
          --insecure-options=image \
          --port=port-8080:8080 \
          --port=port-8080:80 \
          /home/core/matchbox/examples/assets/rkt/matchbox.aci

        [Install]
        WantedBy=multi-user.target
    - name: dnsmasq.service
      enable: true
      # systemd-resolv gets dhcp dns server
      # we point dnsmasq at it
      # we point /etc/resolv at dnsmasq
      contents: |
        [Unit]
        Description=dnsmasq

        [Service]
        ExecStart=/usr/bin/rkt run \
          --net=host \
          --trust-keys-from-https \
          --volume config,kind=host,source=/home/core/dnsmasq/bootstrap.conf \
          --volume hosts,kind=host,source=/home/core/dnsmasq/hosts \
          --volume resolv,kind=host,source=/run/systemd/resolve/resolv.conf \
          --mount volume=config,target=/etc/dnsmasq.conf \
          --mount volume=hosts,target=/etc/hosts \
          --mount volume=resolv,target=/etc/resolv.conf \
          --insecure-options=image \
          /home/core/matchbox/examples/assets/rkt/dnsmasq.aci \
          --caps-retain=CAP_NET_ADMIN,CAP_NET_BIND_SERVICE,CAP_SETGID,CAP_SETUID,CAP_NET_RAW \
          -- -d -q \
          --log-queries
        [Install]
        WantedBy=multi-user.target

storage:
#  {{ if index . "pxe" }}
  disks:
    - device: /dev/sda
      wipe_table: true
      partitions:
        - label: ROOT
  filesystems:
    - name: root
      mount:
        device: "/dev/sda1"
        format: "ext4"
        create:
          force: true
          options:
            - "-LROOT"
  files:
    - path: /etc/resolv.conf
      filesystem: root
      contents:
        inline: |
          nameserver 127.0.0.1
#  {{end}}
passwd:
#{{ if index . "ssh_authorized_keys" }}
  users:
    - name: core
      ssh_authorized_keys:
#        {{ range $element := .ssh_authorized_keys }}
        - "{{$element}}"
#        {{end}}
#{{end}}
